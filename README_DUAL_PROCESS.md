# Dual-Process Game Architecture

This project implements a dual-process architecture where polygon movement is generated by a separate Python process and communicated to the main TypeScript Phaser game via WebSocket.

## üèóÔ∏è Architecture Overview

### **Process 1: Python Polygon Generator**
- **File**: `rectangle_generator.py`
- **Purpose**: Generates polygon movement data at 60 FPS
- **Communication**: WebSocket server on `localhost:8765`
- **Movement**: Sine wave up-down motion (2-second cycle) with rotation
- **Shapes**: Configurable polygons (rectangle, triangle, octagon, etc.)

### **Process 2: TypeScript Phaser Game**
- **File**: `phaser-matter-game/src/main.ts`
- **Purpose**: Handles ball physics, rendering, and game logic
- **Communication**: WebSocket client connecting to polygon generator
- **Rendering**: Displays any polygon shape without assumptions about size/shape

## üî∑ Polygon Configuration System

The system supports configurable polygon shapes through JSON configuration files in the `polygon_config/` directory.

### **Available Shapes**
- **Rectangle**: `polygon_config/rectangle.json` (default)
- **Triangle**: `polygon_config/triangle.json`
- **Octagon**: `polygon_config/octagon.json`

### **Configuration Format**
```json
{
  "name": "rectangle",
  "description": "Standard rectangle shape",
  "vertices": [
    {"x": -50, "y": -25},
    {"x": 50, "y": -25},
    {"x": 50, "y": 25},
    {"x": -50, "y": 25}
  ],
  "center_offset": {"x": 0, "y": 0},
  "scale": 1.0
}
```

### **Message Format**
The Python generator sends abstract polygon data:
```json
{
  "position": {"x": 300.0, "y": 400.0},
  "vertices": [{"x": -50, "y": -25}, ...],
  "rotation": 1.57
}
```

## üöÄ Quick Start

### **Option 1: Automated Startup (Recommended)**
```bash
./start_game.sh
```

### **Option 2: Different Polygon Shapes**
```bash
# Rectangle (default)
python3 rectangle_generator.py polygon_config/rectangle.json

# Triangle
python3 rectangle_generator.py polygon_config/triangle.json

# Octagon
python3 rectangle_generator.py polygon_config/octagon.json
```

### **Option 3: Demo All Shapes**
```bash
./demo_polygons.sh
```

### **Option 0: Cleanup Existing Processes**
If you encounter "address already in use" errors:
```bash
./stop_game.sh
```

### **Option 2: Manual Startup**

1. **Install Python dependencies:**
```bash
pip install -r requirements_rectangle.txt
```

2. **Start rectangle generator:**
```bash
python3 rectangle_generator.py
```

3. **Start Phaser game (in another terminal):**
```bash
cd phaser-matter-game
npm run dev
```

4. **Open browser:**
Navigate to `http://localhost:5173`

## üì° Communication Protocol

### **Message Format**
```typescript
interface RectangleMessage {
  timestamp: number;           // Unix timestamp
  position: { x: number; y: number };  // Rectangle position
  velocity: { x: number; y: number };  // Velocity for prediction
  phase: number;              // Sine wave phase
  elapsed_time: number;       // Time since start
}
```

### **WebSocket Endpoints**
- **Server**: `ws://localhost:8765`
- **Protocol**: JSON messages
- **Frequency**: 60 FPS (16.67ms intervals)

## ‚öôÔ∏è Configuration

### **Rectangle Movement Parameters**
```python
# In rectangle_generator.py
self.size = 600              # Game board size
self.amplitude = 90          # Movement range (15% of size)
self.center_y = 330          # Center Y position (55% of size)
self.frequency = 0.5         # 0.5 Hz = 2 second cycle
```

### **Connection Settings**
```typescript
// In main.ts
private connectionRetryDelay: number = 2000; // 2 seconds
```

## üéØ Smooth Movement Features

### **Anti-Jitter System**
- **Message Buffering**: Stores last 3 messages for interpolation
- **Linear Interpolation**: Smooth position calculation between messages
- **50ms Delay**: Compensates for network latency
- **Frame-Accurate Timing**: Precise 60 FPS generation

### **Performance Monitoring**
- **Real-time FPS**: Python process reports actual performance
- **Client Count**: Tracks connected game instances
- **Timing Precision**: Frame-accurate movement generation

## üîß Features

### **Resilient Communication**
- **Auto-reconnection**: Automatically retries WebSocket connection
- **Fallback mode**: Uses local calculation if WebSocket fails
- **Error handling**: Graceful degradation on connection issues

### **Performance Optimized**
- **Low latency**: Direct localhost WebSocket communication
- **High frequency**: 60 FPS rectangle updates
- **Smooth interpolation**: Message buffering and linear interpolation
- **Precise timing**: Frame-accurate movement generation
- **Efficient**: Minimal message overhead

### **Development Friendly**
- **Logging**: Console output for debugging
- **Signal handling**: Graceful shutdown on Ctrl+C
- **Process management**: Automated startup/shutdown

## üêõ Troubleshooting

### **"Address Already in Use" Errors**
```bash
# Quick fix - stop all processes
./stop_game.sh

# Then restart
./start_game.sh
```

### **WebSocket Connection Issues**
1. Check if Python process is running: `ps aux | grep rectangle_generator`
2. Verify port 8765 is available: `netstat -tlnp | grep 8765`
3. Check browser console for WebSocket errors

### **Performance Issues**
1. Monitor Python process CPU usage
2. Check WebSocket message frequency in browser dev tools
3. Verify 60 FPS target is being met

### **Game Not Starting**
1. Ensure all dependencies are installed
2. Check Node.js and Python versions
3. Verify ports 5173 and 8765 are available

## üìä Monitoring

### **Python Process Logs**
```
Starting rectangle generator server on localhost:8765
Target FPS: 20
Client connected. Total clients: 1
```

### **TypeScript Game Logs**
```
Connecting to rectangle generator WebSocket...
Connected to rectangle generator
```

## üß™ Testing

### **Running Tests**
```bash
# Run all tests (Python + TypeScript)
./run_tests.sh

# Run only Python tests
python3 -m pytest test_rectangle_generator.py -v
python3 -m pytest test_integration.py -v

# Run only TypeScript tests
cd phaser-matter-game
npm test

# Run tests with coverage
npm run test:coverage
```

### **Test Coverage**
- **Python Unit Tests**: Rectangle generator functionality, movement calculations, message formatting
- **Python Integration Tests**: WebSocket communication, multi-client support, performance
- **TypeScript Unit Tests**: Game scene logic, WebSocket handling, interpolation
- **End-to-End Tests**: Complete dual-process communication
- **Performance Tests**: Message generation speed, interpolation performance

### **Test Files**
- `test_rectangle_generator.py` - Python unit tests
- `test_integration.py` - Python integration tests  
- `phaser-matter-game/src/test_main.ts` - TypeScript unit tests
- `run_tests.sh` - Complete test runner

## üîÆ Future Enhancements

- **Multiple moving objects**: Extend to support multiple rectangles
- **Complex movements**: Add more sophisticated movement patterns
- **Performance monitoring**: Add FPS and latency metrics
- **Configuration UI**: Web interface for adjusting parameters
- **Scaling**: Support for multiple game instances

## üìù Technical Notes

- **WebSocket Library**: Python `websockets` package
- **Message Format**: JSON for easy debugging
- **Error Recovery**: Automatic reconnection with exponential backoff
- **Process Isolation**: Rectangle generation doesn't affect game performance
- **Cross-platform**: Works on Linux, macOS, Windows
